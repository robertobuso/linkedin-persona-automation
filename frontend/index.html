<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LinkedIn Automation MVP</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üöÄ</text></svg>">
    
    <!-- Load configuration -->
    <script src="/config.js"></script>
    
    <!-- React CDN -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        /* Add loading spinner */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #0077b5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Add toast notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            border-left: 4px solid #28a745;
        }

        .toast.error {
            border-left: 4px solid #dc3545;
        }

        .toast.warning {
            border-left: 4px solid #ffc107;
        }

        .app {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: #0077b5;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 15px;
        }

        .btn-primary {
            background: #0077b5;
            color: white;
        }

        .btn-primary:hover {
            background: #005885;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: #333;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .main-content {
            flex: 1;
            padding: 2rem;
            max-width: 1800px;
            margin: 0 auto;
            width: 100%;
        }

        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 80vh;
        }

        .auth-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
        }

        .auth-card h2 {
            text-align: center;
            margin-bottom: 1.5rem;
            color: #333;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #555;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .form-control:focus {
            outline: none;
            border-color: #0077b5;
        }

        .alert {
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 2rem;
            margin-top: 2rem;
        }

        .sidebar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 1.5rem;
            height: fit-content;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .content-area {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .nav-menu {
            list-style: none;
        }

        .nav-menu li {
            margin-bottom: 0.5rem;
        }

        .nav-menu a {
            display: block;
            padding: 0.75rem;
            text-decoration: none;
            color: #555;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .nav-menu a:hover,
        .nav-menu a.active {
            background: #f8f9fa;
            color: #0077b5;
            transform: translateX(4px);
        }

        .card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border: 1px solid #e9ecef;
            transition: transform 0.2s;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .card h3 {
            margin-bottom: 0.5rem;
            color: #333;
        }

        .card p {
            color: #666;
            margin-bottom: 1rem;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #666;
        }

        .empty-state h3 {
            margin-bottom: 0.5rem;
        }

        .tag {
            display: inline-block;
            background: #e9ecef;
            color: #495057;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-right: 0.25rem;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
            margin-top: 1.2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            margin-top: 25rem;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .main-content {
                padding: 1rem;
            }
            
            .header {
                padding: 1rem;
            }
        }

        .style-dropdown-menu {
            position: absolute; 
            bottom: calc(100% + 5px); /* Position above the button with a small gap */
            left: 0;
            background: white; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            z-index: 10;
            min-width: 200px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 0.5rem 0;
        }

        .style-dropdown-item {
            padding: 0.75rem 1rem; 
            cursor: pointer;
            white-space: nowrap;
            display: flex; /* For spinner alignment */
            align-items: center;
        }

        .style-dropdown-item:hover {
            background: #f0f5fa;
            color: #005885;
        }
    </style>
</head>
<body>
    <div id="root">
        <div style="display: flex; justify-content: center; align-items: center; height: 100vh; flex-direction: column; color: white;">
            <div class="loading-spinner" style="width: 40px; height: 40px; border-width: 4px;"></div>
            <p style="margin-top: 1rem;">Loading LinkedIn Automation...</p>
        </div>
    </div>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        // API Configuration
        const API_BASE = window.APP_CONFIG?.API_BASE_URL || '/api/v1';

        // Toast notification system
        const ToastContext = React.createContext();

        const ToastProvider = ({ children }) => {
            const [toasts, setToasts] = useState([]);

            const addToast = useCallback((message, type = 'info') => {
                const id = Date.now();
                const toast = { id, message, type };
                setToasts(prev => [...prev, toast]);
                
                setTimeout(() => {
                    setToasts(prev => prev.filter(t => t.id !== id));
                }, 5000);
            }, []);

            const removeToast = (id) => {
                setToasts(prev => prev.filter(t => t.id !== id));
            };

            return (
                <ToastContext.Provider value={{ addToast }}>
                    {children}
                    <div style={{ position: 'fixed', top: '20px', right: '20px', zIndex: 1000 }}>
                        {toasts.map(toast => (
                            <div
                                key={toast.id}
                                className={`toast show ${toast.type}`}
                                onClick={() => removeToast(toast.id)}
                                style={{ cursor: 'pointer', marginBottom: '10px' }}
                            >
                                {toast.message}
                            </div>
                        ))}
                    </div>
                </ToastContext.Provider>
            );
        };

        // API Helper with toast notifications
        const useApi = () => {
            const { addToast } = React.useContext(ToastContext);

            const apiCall = useCallback(async (endpoint, options = {}) => {
                const token = localStorage.getItem('token');
                const config = {
                    ...options,
                    headers: {
                        'Content-Type': 'application/json',
                        ...(token && { Authorization: `Bearer ${token}` }),
                        ...options.headers,
                    },
                };

                try {
                    const response = await fetch(`${API_BASE}${endpoint}`, config);
                    
                    if (!response.ok) {
                        const error = await response.json().catch(() => ({ message: 'An error occurred' }));
                        throw new Error(error.message || error.detail || 'API Error');
                    }

                    return response.json();
                } catch (error) {
                    addToast(error.message, 'error');
                    throw error;
                }
            }, [addToast]);

            return { apiCall, addToast };
        };

        // API Helper Functions
        const apiCall = async (endpoint, options = {}) => {
            const token = localStorage.getItem('token');
            const config = {
                ...options,
                headers: {
                    'Content-Type': 'application/json',
                    ...(token && { Authorization: `Bearer ${token}` }),
                    ...options.headers,
                },
            };

            const response = await fetch(`${API_BASE}${endpoint}`, config);
            
            if (!response.ok) {
                const error = await response.json().catch(() => ({ message: 'An error occurred' }));
                throw new Error(error.message || error.detail || 'API Error');
            }

            return response.json();
        };

        // Main App Component
        const App = () => {
            return (
                <ToastProvider>
                    <AppContent />
                </ToastProvider>
            );
        };

        const AppContent = () => {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const { apiCall, addToast } = useApi();

            useEffect(() => {
                const token = localStorage.getItem('token');
                if (token) {
                    apiCall('/auth/me')
                        .then(userData => {
                            setUser(userData);
                            addToast('Welcome back!', 'success');
                        })
                        .catch(() => {
                            localStorage.removeItem('token');
                            setUser(null);
                        })
                        .finally(() => setLoading(false));
                } else {
                    setLoading(false);
                }
            }, [apiCall, addToast]);

            const handleLogin = (userData, token) => {
                localStorage.setItem('token', token);
                setUser(userData);
                addToast('Login successful!', 'success');
            };

            const handleLogout = () => {
                localStorage.removeItem('token');
                setUser(null);
                addToast('Logged out successfully', 'success');
            };

            if (loading) {
                return (
                    <div className="app">
                        <div className="loading">
                            <div className="loading-spinner"></div>
                            <h2 style={{marginTop: '1rem'}}>Loading...</h2>
                        </div>
                    </div>
                );
            }

            return (
                <div className="app">
                    <Header user={user} onLogout={handleLogout} />
                    <main className="main-content">
                        {user ? (
                            <Dashboard user={user} />
                        ) : (
                            <AuthScreen onLogin={handleLogin} />
                        )}
                    </main>
                </div>
            );
        };

        // Header Component
        const Header = ({ user, onLogout }) => (
            <header className="header">
                <div className="logo">LinkedIn Automation MVP</div>
                {user && (
                    <div className="user-menu">
                        <span>Welcome, {user.full_name || user.email}</span>
                        <a 
                            href="/content_preferences.html" 
                            className="btn btn-secondary"
                            target="_blank"
                            rel="noopener noreferrer"
                        >
                            ‚öôÔ∏è Content Preferences
                        </a>
                        <button className="btn btn-secondary" onClick={onLogout}>
                            Logout
                        </button>
                    </div>
                )}
            </header>
        );

        // Authentication Screen
        const AuthScreen = ({ onLogin }) => {
            const [isLogin, setIsLogin] = useState(true);
            const [formData, setFormData] = useState({
                email: '',
                password: '',
                full_name: ''
            });
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');

                try {
                    if (isLogin) {
                        // Login with form data format
                        const formBody = new URLSearchParams();
                        formBody.append('username', formData.email);
                        formBody.append('password', formData.password);

                        const response = await fetch(`${API_BASE}/auth/login`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                            },
                            body: formBody,
                        });

                        if (!response.ok) {
                            const error = await response.json();
                            throw new Error(error.detail || 'Login failed');
                        }

                        const data = await response.json();
                        onLogin(data.user, data.access_token);
                    } else {
                        // Register
                        const data = await apiCall('/auth/register', {
                            method: 'POST',
                            body: JSON.stringify(formData),
                        });
                        onLogin(data.user, data.access_token);
                    }
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            const handleChange = (e) => {
                setFormData({
                    ...formData,
                    [e.target.name]: e.target.value
                });
            };

            return (
                <div className="auth-container">
                    <div className="auth-card">
                        <h2>{isLogin ? 'Login' : 'Register'}</h2>
                        
                        {error && (
                            <div className="alert alert-error">{error}</div>
                        )}

                        <form onSubmit={handleSubmit}>
                            {!isLogin && (
                                <div className="form-group">
                                    <label>Full Name</label>
                                    <input
                                        type="text"
                                        name="full_name"
                                        className="form-control"
                                        value={formData.full_name}
                                        onChange={handleChange}
                                        required
                                    />
                                </div>
                            )}
                            
                            <div className="form-group">
                                <label>Email</label>
                                <input
                                    type="email"
                                    name="email"
                                    className="form-control"
                                    value={formData.email}
                                    onChange={handleChange}
                                    required
                                />
                            </div>
                            
                            <div className="form-group">
                                <label>Password</label>
                                <input
                                    type="password"
                                    name="password"
                                    className="form-control"
                                    value={formData.password}
                                    onChange={handleChange}
                                    required
                                    minLength="8"
                                />
                            </div>
                            
                            <button 
                                type="submit" 
                                className="btn btn-primary" 
                                style={{width: '100%', marginBottom: '1rem'}}
                                disabled={loading}
                            >
                                {loading ? 'Loading...' : (isLogin ? 'Login' : 'Register')}
                            </button>
                        </form>

                        <p style={{textAlign: 'center'}}>
                            {isLogin ? "Don't have an account? " : "Already have an account? "}
                            <button 
                                type="button"
                                className="btn btn-secondary"
                                onClick={() => setIsLogin(!isLogin)}
                                style={{padding: '0.25rem 0.5rem'}}
                            >
                                {isLogin ? 'Register' : 'Login'}
                            </button>
                        </p>
                    </div>
                </div>
            );
        };

        // LinkedIn Status
        const LinkedInConnectionStatus = () => {
            const [status, setStatus] = useState(null);
            const [loading, setLoading] = useState(true);
            const [connecting, setConnecting] = useState(false);
            const { apiCall, addToast } = useApi();

            useEffect(() => {
                loadStatus();
            }, []);

            const loadStatus = async () => {
                try {
                    const data = await apiCall('/auth/linkedin/status');
                    setStatus(data);
                } catch (err) {
                    console.error('Failed to load LinkedIn status:', err);
                } finally {
                    setLoading(false);
                }
            };

            const handleConnect = async () => {
                setConnecting(true);
                try {
                    const response = await apiCall('/auth/linkedin/connect');
                    console.log('LinkedIn connect response:', response);
                    
                    // Create a unique popup window
                    const popup = window.open(
                        response.authorization_url,
                        'linkedin-auth-popup',
                        'width=600,height=700,scrollbars=yes,resizable=yes,centerscreen=yes'
                    );

                    if (!popup) {
                        throw new Error('Failed to open popup window. Please allow popups for this site.');
                    }

                    // Monitor popup for completion
                    let messageReceived = false;
                    
                    const checkClosed = setInterval(() => {
                        if (popup.closed && !messageReceived) {
                            clearInterval(checkClosed);
                            setConnecting(false);
                            addToast('LinkedIn connection was cancelled or failed', 'warning');
                        }
                    }, 1000);

                    // Listen for successful auth message from popup
                    const messageHandler = (event) => {
                        console.log('Received message:', event.data);
                        
                        if (event.data?.type === 'linkedin-auth-success') {
                            messageReceived = true;
                            clearInterval(checkClosed);
                            
                            popup.close();
                            setConnecting(false);
                            
                            addToast('LinkedIn connected successfully!', 'success');
                            loadStatus(); // Refresh the status
                            
                            window.removeEventListener('message', messageHandler);
                        }
                    };
                    
                    window.addEventListener('message', messageHandler);

                    // Clean up if popup is closed manually
                    const cleanupHandler = () => {
                        clearInterval(checkClosed);
                        window.removeEventListener('message', messageHandler);
                        setConnecting(false);
                    };

                    // Set a timeout to clean up after 5 minutes
                    setTimeout(() => {
                        if (!messageReceived && !popup.closed) {
                            popup.close();
                            cleanupHandler();
                            addToast('LinkedIn connection timed out', 'error');
                        }
                    }, 300000); // 5 minutes

                } catch (err) {
                    console.error('LinkedIn connection error:', err);
                    addToast('Failed to connect LinkedIn: ' + err.message, 'error');
                    setConnecting(false);
                }
            };

            const handleDisconnect = async () => {
                if (!confirm('Are you sure you want to disconnect your LinkedIn account?')) {
                    return;
                }

                try {
                    await apiCall('/auth/linkedin/disconnect', { method: 'DELETE' });
                    setStatus({ ...status, connected: false, has_token: false, profile: null });
                    addToast('LinkedIn disconnected successfully', 'success');
                } catch (err) {
                    addToast('Failed to disconnect LinkedIn: ' + err.message, 'error');
                }
            };

            if (loading) {
                return (
                    <div className="card">
                        <h3>üîó LinkedIn Connection</h3>
                        <div className="loading">Loading LinkedIn status...</div>
                    </div>
                );
            }

            return (
                <div className="card">
                    <h3>üîó LinkedIn Connection</h3>
                    
                    {status?.connected ? (
                        <div>
                            <div className="alert alert-success">
                                ‚úÖ LinkedIn account is connected
                                {status.profile && (
                                    <div style={{marginTop: '0.5rem'}}>
                                        <strong>Connected as:</strong> {status.profile.name || 'LinkedIn User'}
                                    </div>
                                )}
                                {status.token_expires_at && (
                                    <div style={{fontSize: '0.9rem', marginTop: '0.25rem', color: '#666'}}>
                                        <strong>Token expires:</strong> {new Date(status.token_expires_at).toLocaleString()}
                                    </div>
                                )}
                            </div>
                            <button 
                                className="btn btn-danger"
                                onClick={handleDisconnect}
                            >
                                Disconnect LinkedIn
                            </button>
                        </div>
                    ) : (
                        <div>
                            <div className="alert alert-warning" style={{background: '#fff3cd', color: '#856404', border: '1px solid #ffeaa7'}}>
                                ‚ö†Ô∏è LinkedIn account not connected. Connect your LinkedIn account to publish posts and engage with content.
                            </div>
                            <button 
                                className="btn btn-primary"
                                onClick={handleConnect}
                                disabled={connecting}
                                style={{
                                    opacity: connecting ? 0.7 : 1,
                                    cursor: connecting ? 'not-allowed' : 'pointer'
                                }}
                            >
                                {connecting ? (
                                    <>
                                        <span className="loading-spinner" style={{
                                            width: '1em', 
                                            height: '1em', 
                                            marginRight: '0.5rem',
                                            display: 'inline-block',
                                            border: '2px solid rgba(255,255,255,0.3)',
                                            borderTop: '2px solid white',
                                            borderRadius: '50%',
                                            animation: 'spin 1s linear infinite'
                                        }}></span>
                                        Connecting to LinkedIn...
                                    </>
                                ) : (
                                    'üîó Connect LinkedIn'
                                )}
                            </button>
                        </div>
                    )}

                    <div style={{marginTop: '1rem', fontSize: '0.9rem', color: '#666'}}>
                        <h4>What LinkedIn connection enables:</h4>
                        <ul style={{marginTop: '0.5rem', paddingLeft: '1.5rem', textAlign: 'left'}}>
                            <li>Publish posts directly to your LinkedIn feed</li>
                            <li>Comment on LinkedIn posts automatically</li>
                            <li>Like posts and engage with your network</li>
                            <li>Track performance of your published content</li>
                        </ul>
                    </div>
                </div>
            );
        };

        // Dashboard Component
        const Dashboard = ({ user }) => {
            const [activeTab, setActiveTab] = useState('overview');

            return (
                <div className="dashboard">
                    <aside className="sidebar">
                        <h3>Navigation</h3>
                        <ul className="nav-menu">
                            {/* Existing tabs */}
                            <li><a href="#" className={activeTab === 'overview' ? 'active' : ''} onClick={(e) => { e.preventDefault(); setActiveTab('overview'); }}>üìä Overview</a></li>
                            <li><a href="#" className={activeTab === 'sources' ? 'active' : ''} onClick={(e) => { e.preventDefault(); setActiveTab('sources'); }}>üì° Content Sources</a></li>
                            <li><a href="#" className={activeTab === 'feed' ? 'active' : ''} onClick={(e) => { e.preventDefault(); setActiveTab('feed'); }}>üì∞ Content Feed</a></li>
                            <li><a href="#" className={activeTab === 'drafts' ? 'active' : ''} onClick={(e) => { e.preventDefault(); setActiveTab('drafts'); }}>‚úèÔ∏è Post Drafts</a></li>
                            
                            {/* NEW: Comment Management Section */}
                            <li style={{borderTop: '1px solid #e9ecef', marginTop: '1rem', paddingTop: '1rem'}}>
                                <span style={{fontSize: '0.9rem', fontWeight: 'bold', color: '#666', textTransform: 'uppercase', letterSpacing: '0.5px'}}>
                                    Comment Management
                                </span>
                            </li>
                            <li><a href="#" className={activeTab === 'comment-discovery' ? 'active' : ''} onClick={(e) => { e.preventDefault(); setActiveTab('comment-discovery'); }}>üîç Comment Discovery</a></li>
                            <li><a href="#" className={activeTab === 'comment-queue' ? 'active' : ''} onClick={(e) => { e.preventDefault(); setActiveTab('comment-queue'); }}>üìù Comment Queue</a></li>
                            <li><a href="#" className={activeTab === 'comment-analytics' ? 'active' : ''} onClick={(e) => { e.preventDefault(); setActiveTab('comment-analytics'); }}>üìà Comment Analytics</a></li>
                            
                            {/* Existing preferences tab */}
                            <li style={{borderTop: '1px solid #e9ecef', marginTop: '1rem', paddingTop: '1rem'}}>
                                <a href="#" className={activeTab === 'preferences' ? 'active' : ''} onClick={(e) => { e.preventDefault(); setActiveTab('preferences'); }}>‚öôÔ∏è Settings</a>
                            </li>
                        </ul>
                    </aside>

                    <div className="content-area">
                        {/* Existing tabs */}
                        {activeTab === 'overview' && <OverviewTab />}
                        {activeTab === 'sources' && <SourcesTab />}
                        {activeTab === 'feed' && <FeedTab />}
                        {activeTab === 'drafts' && <DraftsTab />}
                        {activeTab === 'preferences' && <PreferencesTab />}
                        
                        {/* NEW: Comment Management tabs */}
                        {activeTab === 'comment-discovery' && <CommentDiscoveryTab />}
                        {activeTab === 'comment-queue' && <CommentQueueTab />}
                        {activeTab === 'comment-analytics' && <CommentAnalyticsTab />}
                    </div>
                </div>
            );
        };

        // Overview Tab - FIXED with real API calls
        const OverviewTab = () => {
            const [stats, setStats] = useState(null);
            const [commentStats, setCommentStats] = useState(null);
            const [loading, setLoading] = useState(true);
            const { apiCall } = useApi();

            useEffect(() => {
                loadAllStats();
            }, []);

            const loadAllStats = async () => {
                setLoading(true);
                try {
                    // Load existing content stats
                    const contentStats = await apiCall('/content/stats');
                    const draftStats = await apiCall('/drafts/stats/summary');
                    
                    // Load new comment stats
                    const commentAnalytics = await apiCall('/engagement/comment-analytics?days=30');
                    
                    setStats({
                        sources: contentStats.total_sources || 0,
                        active_sources: contentStats.active_sources || 0,
                        content_items: contentStats.total_items_processed || 0,
                        drafts: draftStats.total_drafts || 0,
                        published: draftStats.published || 0
                    });

                    setCommentStats({
                        opportunities: commentAnalytics.total_comment_opportunities || 0,
                        comments_posted: commentAnalytics.comments_posted || 0,
                        success_rate: commentAnalytics.success_rate || 0,
                        pending: commentAnalytics.comments_pending || 0
                    });
                    
                } catch (err) {
                    console.error('Failed to load stats:', err);
                    // Fallback stats
                    setStats({
                        sources: 0,
                        active_sources: 0,
                        content_items: 0,
                        drafts: 0,
                        published: 0
                    });
                    setCommentStats({
                        opportunities: 0,
                        comments_posted: 0,
                        success_rate: 0,
                        pending: 0
                    });
                } finally {
                    setLoading(false);
                }
            };

            if (loading) {
                return <div className="loading">Loading overview...</div>;
            }

            return (
                <div>
                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem'}}>
                        <h2>Dashboard Overview</h2>
                        <button 
                            className="btn btn-secondary"
                            onClick={loadAllStats}
                            disabled={loading}
                        >
                            {loading ? 'üîÑ Loading...' : 'üîÑ Refresh'}
                        </button>
                    </div>
                    
                    {/* Content Statistics */}
                    <div style={{marginBottom: '2rem'}}>
                        <h3 style={{marginBottom: '1rem', color: '#0077b5'}}>Content Pipeline</h3>
                        <div className="stats">
                            <div className="stat-card">
                                <div className="stat-number">{stats.sources}</div>
                                <div>Total Sources</div>
                            </div>
                            <div className="stat-card">
                                <div className="stat-number">{stats.active_sources}</div>
                                <div>Active Sources</div>
                            </div>
                            <div className="stat-card">
                                <div className="stat-number">{stats.content_items}</div>
                                <div>Content Items</div>
                            </div>
                            <div className="stat-card">
                                <div className="stat-number">{stats.drafts}</div>
                                <div>Draft Posts</div>
                            </div>
                            <div className="stat-card">
                                <div className="stat-number">{stats.published}</div>
                                <div>Published Posts</div>
                            </div>
                        </div>
                    </div>

                    {/* NEW: Comment Statistics */}
                    <div style={{marginBottom: '2rem'}}>
                        <h3 style={{marginBottom: '1rem', color: '#0077b5'}}>Comment Automation</h3>
                        <div className="stats">
                            <div className="stat-card">
                                <div className="stat-number">{commentStats.opportunities}</div>
                                <div>Opportunities Found</div>
                            </div>
                            <div className="stat-card">
                                <div className="stat-number">{commentStats.comments_posted}</div>
                                <div>Comments Posted</div>
                            </div>
                            <div className="stat-card">
                                <div className="stat-number">{commentStats.success_rate.toFixed(0)}%</div>
                                <div>Success Rate</div>
                            </div>
                            <div className="stat-card">
                                <div className="stat-number">{commentStats.pending}</div>
                                <div>Pending Actions</div>
                            </div>
                        </div>
                    </div>

                    {/* Getting Started Guide - Updated */}
                    <div className="card">
                        <h3>üöÄ LinkedIn Automation Workflow</h3>
                        <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '2rem', marginTop: '1rem'}}>
                            <div>
                                <h4 style={{color: '#0077b5', marginBottom: '1rem'}}>üì∞ Content Creation</h4>
                                <ol style={{paddingLeft: '1.5rem'}}>
                                    <li>Add content sources (RSS feeds, LinkedIn profiles)</li>
                                    <li>Let the system discover and process content</li>
                                    <li>Review and generate post drafts</li>
                                    <li>Schedule or publish your posts</li>
                                </ol>
                                <div style={{marginTop: '1rem'}}>
                                    <button 
                                        className="btn btn-primary"
                                        onClick={() => window.location.hash = 'sources'}
                                        style={{marginRight: '0.5rem'}}
                                    >
                                        Add Sources
                                    </button>
                                    <button 
                                        className="btn btn-secondary"
                                        onClick={() => window.location.hash = 'drafts'}
                                    >
                                        View Drafts
                                    </button>
                                </div>
                            </div>
                            
                            <div>
                                <h4 style={{color: '#0077b5', marginBottom: '1rem'}}>üí¨ Comment Automation</h4>
                                <ol style={{paddingLeft: '1.5rem'}}>
                                    <li>Discover LinkedIn posts for commenting</li>
                                    <li>AI analyzes relevance and generates comments</li>
                                    <li>Review and schedule comment opportunities</li>
                                    <li>Track engagement and performance</li>
                                </ol>
                                <div style={{marginTop: '1rem'}}>
                                    <button 
                                        className="btn btn-primary"
                                        onClick={() => window.location.hash = 'comment-discovery'}
                                        style={{marginRight: '0.5rem'}}
                                    >
                                        Discover Posts
                                    </button>
                                    <button 
                                        className="btn btn-secondary"
                                        onClick={() => window.location.hash = 'comment-queue'}
                                    >
                                        Comment Queue
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Quick Actions */}
                    <div className="card" style={{marginTop: '2rem'}}>
                        <h3>‚ö° Quick Actions</h3>
                        <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '1rem', marginTop: '1rem'}}>
                            <QuickActionButton 
                                icon="üîç"
                                title="Discover New Posts"
                                description="Find commenting opportunities"
                                onClick={async () => {
                                    try {
                                        await apiCall('/engagement/discover-posts', { method: 'POST' });
                                        addToast('Post discovery started!', 'success');
                                    } catch (err) {
                                        addToast('Discovery failed: ' + err.message, 'error');
                                    }
                                }}
                            />
                            
                            <QuickActionButton 
                                icon="üéØ"
                                title="Smart Content Selection"
                                description="Select content using AI"
                                onClick={async () => {
                                    try {
                                        await apiCall('/content/select-content', { method: 'POST' });
                                        addToast('Content selection completed!', 'success');
                                    } catch (err) {
                                        addToast('Selection failed: ' + err.message, 'error');
                                    }
                                }}
                            />
                            
                            <QuickActionButton 
                                icon="üìù"
                                title="Generate Drafts"
                                description="Create new post drafts"
                                onClick={() => setActiveTab('drafts')}
                            />
                            
                            <QuickActionButton 
                                icon="‚öôÔ∏è"
                                title="Update Preferences"
                                description="Configure content preferences"
                                onClick={() => window.open('/content_preferences.html', '_blank')}
                            />
                        </div>
                    </div>

                    {/* System Status - Updated */}
                    <div className="card" style={{marginTop: '2rem'}}>
                        <h3>üîß System Status</h3>
                        <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '2rem', marginTop: '1rem'}}>
                            <div>
                                <h4>Content Pipeline Health</h4>
                                <SystemHealthIndicator 
                                    label="Active Sources"
                                    value={stats.active_sources}
                                    threshold={1}
                                    type="sources"
                                />
                                <SystemHealthIndicator 
                                    label="Content Processing"
                                    value={stats.content_items > 0 ? "Active" : "Inactive"}
                                    threshold={0}
                                    type="processing"
                                />
                                <SystemHealthIndicator 
                                    label="Draft Generation"
                                    value={stats.drafts > 0 ? "Working" : "No Drafts"}
                                    threshold={0}
                                    type="drafts"
                                />
                            </div>
                            
                            <div>
                                <h4>Comment Automation Health</h4>
                                <SystemHealthIndicator 
                                    label="Opportunity Discovery"
                                    value={commentStats.opportunities > 0 ? "Active" : "No Opportunities"}
                                    threshold={0}
                                    type="discovery"
                                />
                                <SystemHealthIndicator 
                                    label="Comment Success Rate"
                                    value={`${commentStats.success_rate.toFixed(0)}%`}
                                    threshold={50}
                                    type="success_rate"
                                />
                                <SystemHealthIndicator 
                                    label="Pending Actions"
                                    value={commentStats.pending}
                                    threshold={10}
                                    type="pending"
                                />
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Quick Action Button Component
        const QuickActionButton = ({ icon, title, description, onClick }) => {
            const [loading, setLoading] = useState(false);

            const handleClick = async () => {
                if (typeof onClick === 'function') {
                    setLoading(true);
                    try {
                        await onClick();
                    } catch (err) {
                        console.error('Quick action failed:', err);
                    } finally {
                        setLoading(false);
                    }
                }
            };

            return (
                <div 
                    className="card" 
                    style={{
                        cursor: 'pointer',
                        transition: 'all 0.2s',
                        border: '2px solid transparent',
                        padding: '1rem'
                    }}
                    onClick={handleClick}
                    onMouseEnter={(e) => {
                        e.target.style.borderColor = '#0077b5';
                        e.target.style.transform = 'translateY(-2px)';
                    }}
                    onMouseLeave={(e) => {
                        e.target.style.borderColor = 'transparent';
                        e.target.style.transform = 'translateY(0)';
                    }}
                >
                    <div style={{textAlign: 'center'}}>
                        <div style={{fontSize: '2rem', marginBottom: '0.5rem'}}>
                            {loading ? <span className="loading-spinner" style={{width: '2rem', height: '2rem', borderWidth: '3px'}} /> : icon}
                        </div>
                        <h4 style={{margin: '0 0 0.5rem 0', color: '#0077b5'}}>{title}</h4>
                        <p style={{margin: 0, fontSize: '0.9rem', color: '#666'}}>{description}</p>
                    </div>
                </div>
            );
        };

        // System Health Indicator Component
        const SystemHealthIndicator = ({ label, value, threshold, type }) => {
            const getHealthStatus = () => {
                switch (type) {
                    case 'sources':
                        return value >= threshold ? 'healthy' : 'warning';
                    case 'processing':
                        return value === 'Active' ? 'healthy' : 'warning';
                    case 'drafts':
                        return value === 'Working' ? 'healthy' : 'info';
                    case 'discovery':
                        return value === 'Active' ? 'healthy' : 'info';
                    case 'success_rate':
                        const rate = parseFloat(value);
                        if (rate >= 80) return 'healthy';
                        if (rate >= 50) return 'warning';
                        return 'error';
                    case 'pending':
                        if (value === 0) return 'info';
                        if (value <= threshold) return 'healthy';
                        return 'warning';
                    default:
                        return 'info';
                }
            };

            const getStatusColor = (status) => {
                switch (status) {
                    case 'healthy': return '#28a745';
                    case 'warning': return '#ffc107';
                    case 'error': return '#dc3545';
                    case 'info': return '#17a2b8';
                    default: return '#6c757d';
                }
            };

            const getStatusIcon = (status) => {
                switch (status) {
                    case 'healthy': return '‚úÖ';
                    case 'warning': return '‚ö†Ô∏è';
                    case 'error': return '‚ùå';
                    case 'info': return '‚ÑπÔ∏è';
                    default: return '‚ö™';
                }
            };

            const status = getHealthStatus();

            return (
                <div style={{
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center',
                    padding: '0.5rem 0',
                    borderBottom: '1px solid #f0f0f0'
                }}>
                    <span>{label}</span>
                    <div style={{display: 'flex', alignItems: 'center', gap: '0.5rem'}}>
                        <span style={{color: getStatusColor(status), fontWeight: 'bold'}}>{value}</span>
                        <span>{getStatusIcon(status)}</span>
                    </div>
                </div>
            );
        };

        // Sources Tab - FIXED with edit functionality and immediate content ingestion
        const SourcesTab = () => {
            const [sources, setSources] = useState([]);
            const [loading, setLoading] = useState(true);
            const [showModal, setShowModal] = useState(false);
            const [editingSource, setEditingSource] = useState(null);
            const [error, setError] = useState('');
            const { apiCall, addToast } = useApi();

            useEffect(() => {
                loadSources();
            }, []);

            const loadSources = async () => {
                try {
                    const data = await apiCall('/content/sources');
                    setSources(data);
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            const handleSourceAdded = (newSource) => {
                setSources([...sources, newSource]);
                setShowModal(false);
                
                // Trigger content ingestion for the new source
                triggerContentIngestion(newSource.id);
            };

            const handleSourceUpdated = (updatedSource) => {
                setSources(sources.map(s => s.id === updatedSource.id ? updatedSource : s));
                setEditingSource(null);
                setShowModal(false);
            };

            const handleEdit = (source) => {
                setEditingSource(source);
                setShowModal(true);
            };

            const triggerContentIngestion = async (sourceId = null) => {
                try {
                    const url = sourceId ? 
                        `/content/trigger-ingestion?source_id=${sourceId}&force_refresh=true` : 
                        '/content/trigger-ingestion?force_refresh=true';
                    
                    await apiCall(url, {
                        method: 'POST'
                    });
                    
                    if (sourceId) {
                        addToast('Content ingestion started for this source! Check back in a few minutes.', 'success');
                    } else {
                        addToast('Content ingestion started for all sources! Check back in a few minutes.', 'success');
                    }
                } catch (err) {
                    console.error('Failed to trigger ingestion:', err);
                    if (sourceId) {
                        addToast('Content ingestion could not be started, but the source was created successfully.', 'warning');
                    } else {
                        addToast('Failed to trigger content ingestion.', 'error');
                    }
                }
            };

            if (loading) {
                return <div className="loading">Loading sources...</div>;
            }

            return (
                <div>
                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '2rem'}}>
                        <h2>Content Sources</h2>
                        <div style={{display: 'flex', gap: '0.5rem'}}>
                            <button 
                                className="btn btn-secondary"
                                onClick={() => triggerContentIngestion()}
                                disabled={loading}
                            >
                                üîÑ Refresh All
                            </button>
                            <button 
                                className="btn btn-primary"
                                onClick={() => setShowModal(true)}
                            >
                                ‚ûï Add Source
                            </button>
                        </div>
                    </div>

                    {error && (
                        <div className="alert alert-error">{error}</div>
                    )}

                    {sources.length === 0 ? (
                        <div className="empty-state">
                            <h3>No content sources yet</h3>
                            <p>Add your first content source to start discovering content!</p>
                            <button 
                                className="btn btn-primary"
                                onClick={() => setShowModal(true)}
                            >
                                Add Your First Source
                            </button>
                        </div>
                    ) : (
                        <div>
                            {sources.map(source => (
                                <SourceCard 
                                    key={source.id} 
                                    source={source} 
                                    onEdit={handleEdit}
                                />
                            ))}
                        </div>
                    )}

                    {showModal && (
                        <SourceModal 
                            source={editingSource}
                            onClose={() => {
                                setShowModal(false);
                                setEditingSource(null);
                            }}
                            onSourceSaved={editingSource ? handleSourceUpdated : handleSourceAdded}
                        />
                    )}
                </div>
            );
        };

        // Source Card Component - FIXED with edit functionality and URL display
        const SourceCard = ({ source, onEdit }) => (
            <div className="card">
                <h3>{source.name}</h3>
                <p>{source.description}</p>
                {source.url && (
                    <p style={{fontSize: '0.9rem', color: '#666', marginBottom: '0.5rem'}}>
                        <strong>URL:</strong> {source.url}
                    </p>
                )}
                <div style={{marginBottom: '1rem'}}>
                    <span className="tag">{source.source_type}</span>
                    <span className="tag">{source.is_active ? 'Active' : 'Inactive'}</span>
                    <span className="tag">Check every {source.check_frequency_hours}h</span>
                </div>
                <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                    <div>
                        <small>Found: {source.total_items_found} | Processed: {source.total_items_processed}</small>
                        {source.last_checked_at && (
                            <><br/><small>Last checked: {new Date(source.last_checked_at).toLocaleString()}</small></>
                        )}
                    </div>
                    <div>
                        <button 
                            className="btn btn-secondary"
                            onClick={() => onEdit(source)}
                        >
                            ‚öôÔ∏è Edit
                        </button>
                    </div>
                </div>
            </div>
        );

        // Source Modal (Add/Edit) - NEW unified modal for both add and edit
        const SourceModal = ({ source, onClose, onSourceSaved }) => {
            const isEditing = !!source;
            const [formData, setFormData] = useState({
                name: source?.name || '',
                source_type: source?.source_type || 'rss_feed',
                url: source?.url || '',
                description: source?.description || '',
                check_frequency_hours: source?.check_frequency_hours || 24,
                is_active: source?.is_active ?? true
            });
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const { apiCall } = useApi();

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');

                try {
                    let data;
                    if (isEditing) {
                        data = await apiCall(`/content/sources/${source.id}`, {
                            method: 'PUT',
                            body: JSON.stringify(formData),
                        });
                    } else {
                        data = await apiCall('/content/sources', {
                            method: 'POST',
                            body: JSON.stringify(formData),
                        });
                    }
                    onSourceSaved(data);
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            const handleChange = (e) => {
                const value = e.target.type === 'checkbox' ? e.target.checked : e.target.value;
                setFormData({
                    ...formData,
                    [e.target.name]: value
                });
            };

            return (
                <div className="modal">
                    <div className="modal-content">
                        <div className="modal-header">
                            <h3>{isEditing ? 'Edit Content Source' : 'Add Content Source'}</h3>
                            <button className="close-btn" onClick={onClose}>√ó</button>
                        </div>

                        {error && (
                            <div className="alert alert-error">{error}</div>
                        )}

                        <form onSubmit={handleSubmit}>
                            <div className="form-group">
                                <label>Name</label>
                                <input
                                    type="text"
                                    name="name"
                                    className="form-control"
                                    value={formData.name}
                                    onChange={handleChange}
                                    required
                                />
                            </div>

                            <div className="form-group">
                                <label>Type</label>
                                <select
                                    name="source_type"
                                    className="form-control"
                                    value={formData.source_type}
                                    onChange={handleChange}
                                    disabled={isEditing} // Don't allow changing type when editing
                                >
                                    <option value="rss_feed">RSS Feed</option>
                                    <option value="linkedin">LinkedIn Profile</option>
                                </select>
                            </div>

                            <div className="form-group">
                                <label>URL</label>
                                <input
                                    type="url"
                                    name="url"
                                    className="form-control"
                                    value={formData.url}
                                    onChange={handleChange}
                                    required
                                    placeholder="https://example.com/feed.xml"
                                />
                            </div>

                            <div className="form-group">
                                <label>Description</label>
                                <textarea
                                    name="description"
                                    className="form-control"
                                    value={formData.description}
                                    onChange={handleChange}
                                    rows="3"
                                />
                            </div>

                            <div className="form-group">
                                <label>Check Frequency (hours)</label>
                                <input
                                    type="number"
                                    name="check_frequency_hours"
                                    className="form-control"
                                    value={formData.check_frequency_hours}
                                    onChange={handleChange}
                                    min="1"
                                    max="168"
                                />
                            </div>

                            {isEditing && (
                                <div className="form-group">
                                    <label style={{display: 'flex', alignItems: 'center', gap: '0.5rem'}}>
                                        <input
                                            type="checkbox"
                                            name="is_active"
                                            checked={formData.is_active}
                                            onChange={handleChange}
                                        />
                                        Active
                                    </label>
                                </div>
                            )}

                            <div style={{display: 'flex', gap: '1rem', justifyContent: 'flex-end'}}>
                                <button 
                                    type="button" 
                                    className="btn btn-secondary"
                                    onClick={onClose}
                                >
                                    Cancel
                                </button>
                                <button 
                                    type="submit" 
                                    className="btn btn-primary"
                                    disabled={loading}
                                >
                                    {loading ? (isEditing ? 'Updating...' : 'Adding...') : (isEditing ? 'Update Source' : 'Add Source')}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        // Preferences Tab Component
        const PreferencesTab = () => {
            const [preferences, setPreferences] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState('');
            const { apiCall, addToast } = useApi();

            useEffect(() => {
                loadPreferences();
            }, []);

            const loadPreferences = async () => {
                try {
                    const data = await apiCall('/preferences/preferences');
                    setPreferences(data);
                } catch (err) {
                    if (err.message.includes('not found')) {
                        setPreferences(null);
                    } else {
                        setError(err.message);
                    }
                } finally {
                    setLoading(false);
                }
            };

            const triggerContentSelection = async () => {
                try {
                    setLoading(true);
                    const result = await apiCall('/content/select-content', {
                        method: 'POST'
                    });
                    
                    addToast(`Content selection completed! ${result.selection_metadata.articles_selected} articles selected`, 'success');
                    
                } catch (err) {
                    addToast('Content selection failed: ' + err.message, 'error');
                } finally {
                    setLoading(false);
                }
            };

            if (loading) {
                return <div className="loading">Loading preferences...</div>;
            }

            return (
                <div>
                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '2rem'}}>
                        <h2>Settings & Preferences</h2>
                        <div style={{display: 'flex', gap: '0.5rem'}}>
                            <button 
                                className="btn btn-secondary"
                                onClick={triggerContentSelection}
                                disabled={loading}
                            >
                                üéØ Select Content
                            </button>
                            <a 
                                href="/content_preferences.html" 
                                className="btn btn-primary"
                                target="_blank"
                                rel="noopener noreferrer"
                            >
                                ‚öôÔ∏è Content Preferences
                            </a>
                        </div>
                    </div>

                    {error && (
                        <div className="alert alert-error">{error}</div>
                    )}

                    {/* ADD THIS: LinkedIn Connection Status */}
                    <LinkedInConnectionStatus />

                    {/* Existing preferences display */}
                    {preferences ? (
                        <div className="card">
                            <h3>Content Preferences</h3>
                            <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem', marginBottom: '1rem'}}>
                                {preferences.job_role && (
                                    <div><strong>Job Role:</strong> {preferences.job_role}</div>
                                )}
                                {preferences.industry && (
                                    <div><strong>Industry:</strong> {preferences.industry}</div>
                                )}
                                <div><strong>Max Articles/Day:</strong> {preferences.max_articles_per_day}</div>
                                <div><strong>Relevance Threshold:</strong> {Math.round(preferences.min_relevance_score * 100)}%</div>
                            </div>
                            
                            {preferences.primary_interests && preferences.primary_interests.length > 0 && (
                                <div style={{marginBottom: '1rem'}}>
                                    <strong>Primary Interests:</strong>
                                    <div style={{marginTop: '0.5rem'}}>
                                        {preferences.primary_interests.map(interest => (
                                            <span key={interest} className="tag">{interest}</span>
                                        ))}
                                    </div>
                                </div>
                            )}
                            
                            {preferences.custom_prompt && (
                                <div>
                                    <strong>Custom Instructions:</strong>
                                    <p style={{fontStyle: 'italic', marginTop: '0.5rem'}}>{preferences.custom_prompt}</p>
                                </div>
                            )}
                        </div>
                    ) : (
                        <div className="empty-state">
                            <h3>No preferences configured</h3>
                            <p>Set up your content preferences to get personalized article recommendations!</p>
                            <a 
                                href="/content_preferences.html" 
                                className="btn btn-primary"
                                target="_blank"
                                rel="noopener noreferrer"
                            >
                                Set Up Preferences
                            </a>
                        </div>
                    )}
                </div>
            );
        };

        // FeedTab
        const FeedTab = () => {
            const [content, setContent] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState('');
            const { apiCall, addToast } = useApi();

            useEffect(() => {
                loadContent();
            }, []);

            const loadContent = async () => {
                try {
                    const data = await apiCall('/content/feed');
                    setContent(data);
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            if (loading) {
                return <div className="loading">Loading content...</div>;
            }

            return (
                <div>
                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '2rem'}}>
                        <h2>Content Feed</h2>
                        <div style={{display: 'flex', gap: '0.5rem'}}>
                            <button 
                                className="btn btn-secondary"
                                onClick={async () => {
                                    try {
                                        await apiCall('/content/select-content', { method: 'POST' });
                                        addToast('Smart content selection completed!', 'success');
                                        loadContent(); // Refresh feed
                                    } catch (err) {
                                        addToast('Content selection failed: ' + err.message, 'error');
                                    }
                                }}
                                disabled={loading}
                            >
                                üß† Smart Selection
                            </button>
                            <button 
                                className="btn btn-secondary"
                                onClick={loadContent}
                                disabled={loading}
                            >
                                üîÑ Refresh
                            </button>
                        </div>
                    </div>

                    {error && (
                        <div className="alert alert-error">{error}</div>
                    )}

                    {content.length === 0 ? (
                        <div className="empty-state">
                            <h3>No content found</h3>
                            <p>Add some content sources and wait for content to be discovered!</p>
                        </div>
                    ) : (
                        <div>
                            {content.map(item => (
                                <ContentCard key={item.id} item={item} />
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        // Content Card Component
        const ContentCard = ({ item }) => {
            const handleGenerateDraft = async () => {
                try {
                    await apiCall('/drafts', {
                        method: 'POST',
                        body: JSON.stringify({
                            content_item_id: item.id
                        }),
                    });
                    alert('Draft generated successfully!');
                } catch (err) {
                    alert('Failed to generate draft: ' + err.message);
                }
            };

            return (
                <div className="card">
                    <h3>{item.title}</h3>
                    <p>{item.content.substring(0, 200)}...</p>
                    <div style={{marginBottom: '1rem'}}>
                        {item.tags.map(tag => (
                            <span key={tag} className="tag">{tag}</span>
                        ))}
                        {item.relevance_score && (
                            <span className="tag">Score: {item.relevance_score}</span>
                        )}
                    </div>
                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                        <div>
                            <small>
                                {item.author && `By ${item.author} ‚Ä¢ `}
                                {item.published_at && new Date(item.published_at).toLocaleDateString()}
                            </small>
                        </div>
                        <div>
                            <button 
                                className="btn btn-primary"
                                onClick={handleGenerateDraft}
                            >
                                ‚ú® Generate Draft
                            </button>
                            <a 
                                href={item.url} 
                                target="_blank" 
                                rel="noopener noreferrer"
                                className="btn btn-secondary"
                                style={{marginLeft: '0.5rem'}}
                            >
                                üîó View Original
                            </a>
                        </div>
                    </div>
                </div>
            );
        };

        // Drafts Tab
        const DraftsTab = () => {
            const [drafts, setDrafts] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState('');
            const { apiCall, addToast } = useApi(); // Assuming addToast is available via useApi
            const [isBatchLoading, setIsBatchLoading] = useState(false);

            useEffect(() => {
                loadDrafts();
            }, []);

            const loadDrafts = async () => {
                setLoading(true); // Ensure loading is set when reloading
                try {
                    const data = await apiCall('/drafts');
                    setDrafts(data);
                } catch (err) {
                    setError(err.message);
                    addToast(err.message, 'error');
                } finally {
                    setLoading(false);
                }
            };

            const handleBatchGenerate = async () => { // Removed style from param, get it from select
                const selectedStyle = document.getElementById('batchStyleSelect').value;
                if (!selectedStyle) {
                    addToast("Please select a generation style.", "warning");
                    return;
                }
                setIsBatchLoading(true); // Assuming you add a new state: const [isBatchLoading, setIsBatchLoading] = useState(false);
                try {
                    const data = await apiCall(`/drafts/batch-generate?style=${encodeURIComponent(selectedStyle)}&max_posts=5`, { 
                        method: 'POST',
                    });
                    setDrafts(prevDrafts => [...data, ...prevDrafts]); 
                    addToast(`Successfully generated ${data.length} new drafts with style: ${selectedStyle}!`, 'success');
                } catch (err) {
                    addToast('Failed to batch generate drafts: ' + err.message, 'error');
                } finally {
                    setIsBatchLoading(false);
                }
            };
            
            // Function to handle draft updates (e.g., after regeneration)
            const handleDraftUpdated = (updatedDraft) => {
                setDrafts(prevDrafts => prevDrafts.map(d => d.id === updatedDraft.id ? updatedDraft : d));
            };


            if (loading && drafts.length === 0) { // Only show full loading if no drafts are displayed yet
                return <div className="loading">Loading drafts...</div>;
            }

            return (
                <div>
                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem'}}>
                        <h2>Post Drafts</h2>
                        <div style={{display: 'flex', alignItems: 'center', gap: '0.5rem'}}>
                             <label htmlFor="batchStyleSelect" style={{marginRight: '0.5rem', fontWeight: 500}}>Style:</label>
                             <select id="batchStyleSelect" className="form-control" style={{width: 'auto', minWidth: '180px', display: 'inline-block', marginTop:0}}>
                                <option value="professional_thought_leader">Thought Leader</option>
                                <option value="storytelling">Storytelling</option>
                                <option value="educational">Educational</option>
                                <option value="thought_provoking">Thought Provoking (Deep)</option>
                                <option value="engagement_optimized">Engagement Optimized</option>
                                <option value="casual">Casual</option>
                            </select>
                            <button 
                                className="btn btn-primary"
                                onClick={handleBatchGenerate} // No need to pass style here
                                disabled={isBatchLoading || loading} // Use isBatchLoading
                            >
                                {isBatchLoading ? <span className="loading-spinner" /> : 'üéØ'} Generate Batch
                            </button>
                        </div>
                    </div>

                    {error && (
                        <div className="alert alert-error">{error}</div>
                    )}

                    {drafts.length === 0 && !loading ? (
                        <div className="empty-state">
                            <h3>No drafts yet</h3>
                            <p>Generate drafts from your content feed or use batch generation!</p>
                        </div>
                    ) : (
                        <div>
                            {drafts.map(draft => (
                                <DraftCard 
                                    key={draft.id} 
                                    draft={draft} 
                                    onUpdate={handleDraftUpdated} // Pass update handler
                                />
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        // Draft Card Component
        const DraftCard = ({ draft, onUpdate }) => {
            const [editing, setEditing] = useState(false);
            const [content, setContent] = useState(draft.content);
            const [isRegenerating, setIsRegenerating] = useState(false); // For individual regeneration
            const [showStyleOptions, setShowStyleOptions] = useState(false);
            const { apiCall, addToast } = useApi();
            const [activeRegenerationStyle, setActiveRegenerationStyle] = useState(null);

            const availableStyles = [
                {value: "professional_thought_leader", label: "Thought Leader"},
                {value: "storytelling", label: "Storytelling"},
                {value: "educational", label: "Educational (Tips)"},
                {value: "thought_provoking", label: "Thought Provoking (Deep)"},
                {value: "engagement_optimized", label: "Engagement Optimized"},
                {value: "casual", label: "Casual"},
            ];

            const handleSave = async () => {
                setIsRegenerating(true); // Use a general loading state
                try {
                    const updatedDraft = await apiCall(`/drafts/${draft.id}`, {
                        method: 'PUT',
                        body: JSON.stringify({ content: content /*, hashtags: newHashtags (if editable) */ }),
                    });
                    setEditing(false);
                    onUpdate(updatedDraft); // Update the specific draft in the parent
                    addToast('Draft saved successfully!', 'success');
                } catch (err) {
                    addToast('Failed to save draft: ' + err.message, 'error');
                } finally {
                    setIsRegenerating(false);
                }
            };

            const handlePublish = async () => {
                setIsRegenerating(true);
                try {
                    await apiCall(`/drafts/${draft.id}/publish`, {
                        method: 'POST',
                        body: JSON.stringify({}), // Empty body for now
                    });
                    addToast('Draft published successfully! (Mocked)', 'success');
                    onUpdate({...draft, status: 'published', linkedin_post_url: `mock_url/${draft.id}`}); // Optimistic update
                } catch (err) {
                    addToast('Failed to publish draft: ' + err.message, 'error');
                } finally {
                    setIsRegenerating(false);
                }
            };

            const handleRegenerate = async (style) => {
                setShowStyleOptions(false); // Close dropdown
                setActiveRegenerationStyle(style); // Set which style is being regenerated
                // setIsRegenerating(true); // General loading state for the card can still be useful
                try {
                    const regeneratedData = await apiCall(`/drafts/${draft.id}/regenerate?style=${encodeURIComponent(style)}`, {
                        method: 'POST',
                    });
                    setContent(regeneratedData.content);
                    onUpdate(regeneratedData);
                    addToast(`Draft regenerated with style: ${style}!`, 'success');
                } catch (err) {
                    addToast('Failed to regenerate draft: ' + err.message, 'error');
                } finally {
                    setActiveRegenerationStyle(null); // Clear specific style loading
                    // setIsRegenerating(false);
                }
            };

            const handleDelete = async () => {
                if (!confirm("Are you sure you want to delete this draft?")) return;
                setIsRegenerating(true);
                try {
                    await apiCall(`/drafts/${draft.id}`, { method: 'DELETE' });
                    addToast('Draft deleted successfully.', 'success');
                    onUpdate({ ...draft, _deleted: true }); // Signal to parent to filter this out
                } catch (err) {
                    addToast('Failed to delete draft: ' + err.message, 'error');
                } finally {
                    setIsRegenerating(false);
                }
            };

            const getStatusColor = (status) => {
                switch (status) {
                    case 'draft': return '#6c757d';
                    case 'ready': return '#28a745';
                    case 'scheduled': return '#ffc107';
                    case 'published': return '#007bff';
                    case 'failed': return '#dc3545';
                    default: return '#6c757d';
                }
            };

            return (
                <div className="card">
                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '1rem'}}>
                        <h3>{draft.title || 'Untitled Draft'}</h3>
                        <span 
                            className="tag" 
                            style={{
                                background: getStatusColor(draft.status),
                                color: 'white'
                            }}
                        >
                            {draft.status ? draft.status.toUpperCase() : 'UNKNOWN'}
                        </span>
                    </div>


                    {editing ? (
                        <div>
                            <textarea
                                value={content}
                                onChange={(e) => setContent(e.target.value)}
                                className="form-control"
                                rows="8"
                                style={{marginBottom: '1rem'}}
                            />
                            {/* Consider adding hashtag editing here */}
                            <div style={{display: 'flex', gap: '0.5rem'}}>
                                <button className="btn btn-primary" onClick={handleSave} disabled={isRegenerating}>
                                    {isRegenerating ? <span className="loading-spinner" /> : 'üíæ Save'}
                                </button>
                                <button className="btn btn-secondary" onClick={() => { setEditing(false); setContent(draft.content); }}>
                                    ‚ùå Cancel
                                </button>
                            </div>
                        </div>
                    ) : (
                        <div>
                            <p style={{whiteSpace: 'pre-wrap', marginBottom: '1rem'}}>{draft.content}</p>
                            {draft.hashtags && draft.hashtags.length > 0 && (
                                <div style={{marginBottom: '1rem'}}>
                                    {draft.hashtags.map(tag => <span key={tag} className="tag">{tag}</span>)}
                                </div>
                            )}
                           <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginTop: '1rem'}}>
                                <div> {/* Date info */} </div>
                                <div style={{display: 'flex', gap: '0.5rem', flexWrap: 'wrap', alignItems: 'center'}}>
                                    <button 
                                        className="btn btn-secondary" 
                                        onClick={() => setEditing(true)} 
                                        disabled={isRegenerating || activeRegenerationStyle || draft.status === 'published'}>
                                        ‚úèÔ∏è Edit
                                    </button>
                                    
                                    <div style={{ position: 'relative' }}>
                                        <button 
                                            className="btn btn-secondary"
                                            onClick={() => setShowStyleOptions(prev => !prev)}
                                            disabled={isRegenerating || activeRegenerationStyle || draft.status === 'published'}
                                        >
                                            üîÑ Regenerate
                                        </button>
                                        {showStyleOptions && (
                                            <div className="style-dropdown-menu">
                                                {availableStyles.map(styleOpt => (
                                                    <div 
                                                        key={styleOpt.value}
                                                        className="style-dropdown-item"
                                                        onClick={() => handleRegenerate(styleOpt.value)}
                                                    >
                                                        {activeRegenerationStyle === styleOpt.value ? 
                                                            <span className="loading-spinner" style={{width:'1em', height:'1em', borderWidth:'2px', marginRight: '5px'}} /> : null}
                                                        {styleOpt.label}
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>

                                    {draft.status !== 'published' && (
                                        <button 
                                            className="btn btn-primary" 
                                            onClick={handlePublish} 
                                            disabled={isRegenerating || activeRegenerationStyle}>
                                            {isRegenerating && !activeRegenerationStyle ? <span className="loading-spinner" /> : 'üöÄ Publish'}
                                        </button>
                                    )}
                                    <button className="btn btn-danger" style={{background: '#dc3545', color: 'white'}} onClick={handleDelete} disabled={isRegenerating}>
                                        üóëÔ∏è Delete
                                    </button>
                                    {draft.linkedin_post_url && (
                                        <a 
                                            href={draft.linkedin_post_url}
                                            target="_blank"
                                            rel="noopener noreferrer"
                                            className="btn btn-secondary"
                                        >
                                            üîó View Post
                                        </a>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // CommentDiscoveryTab Component
        const CommentDiscoveryTab = () => {
            const [discoveryStatus, setDiscoveryStatus] = useState('idle');
            const [discoveryConfig, setDiscoveryConfig] = useState({
                max_posts: 50,
                sources: ['feed'],
                min_relevance_score: 0.6
            });
            const [lastDiscovery, setLastDiscovery] = useState(null);
            const [opportunities, setOpportunities] = useState([]);
            const [loading, setLoading] = useState(false);
            const { apiCall, addToast } = useApi();

            useEffect(() => {
                loadCommentOpportunities();
            }, []);

            const loadCommentOpportunities = async () => {
                try {
                    setLoading(true);
                    const data = await apiCall('/engagement/comment-opportunities?limit=20');
                    setOpportunities(data);
                } catch (err) {
                    console.error('Failed to load comment opportunities:', err);
                } finally {
                    setLoading(false);
                }
            };

            const handleDiscoverPosts = async () => {
                try {
                    setDiscoveryStatus('running');
                    setLoading(true);
                    
                    const params = new URLSearchParams({
                        max_posts: discoveryConfig.max_posts,
                        sources: discoveryConfig.sources.join(',')
                    });
                    
                    const result = await apiCall(`/engagement/discover-posts?${params}`, {
                        method: 'POST'
                    });
                    
                    setLastDiscovery(result);
                    setDiscoveryStatus('completed');
                    addToast(`Discovery completed! Found ${result.posts_found} posts, created ${result.opportunities_created} opportunities`, 'success');
                    
                    // Refresh opportunities list
                    await loadCommentOpportunities();
                    
                } catch (err) {
                    setDiscoveryStatus('failed');
                    addToast('Post discovery failed: ' + err.message, 'error');
                } finally {
                    setLoading(false);
                }
            };

            const handleConfigChange = (field, value) => {
                setDiscoveryConfig(prev => ({
                    ...prev,
                    [field]: value
                }));
            };

            const handleBulkAction = async (action, opportunityIds) => {
                try {
                    setLoading(true);
                    
                    const result = await apiCall('/engagement/bulk-comment-actions', {
                        method: 'POST',
                        body: JSON.stringify({
                            opportunity_ids: opportunityIds,
                            action: action
                        })
                    });
                    
                    addToast(`Bulk ${action} completed: ${result.results.successful} successful, ${result.results.failed} failed`, 'success');
                    await loadCommentOpportunities();
                    
                } catch (err) {
                    addToast(`Bulk ${action} failed: ` + err.message, 'error');
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div>
                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '2rem'}}>
                        <h2>Comment Discovery</h2>
                        <div style={{display: 'flex', gap: '0.5rem'}}>
                            <button 
                                className="btn btn-secondary"
                                onClick={loadCommentOpportunities}
                                disabled={loading}
                            >
                                üîÑ Refresh
                            </button>
                            <button 
                                className="btn btn-primary"
                                onClick={handleDiscoverPosts}
                                disabled={loading || discoveryStatus === 'running'}
                            >
                                {discoveryStatus === 'running' ? (
                                    <>
                                        <span className="loading-spinner" style={{width: '1em', height: '1em', marginRight: '0.5rem'}} />
                                        Discovering...
                                    </>
                                ) : (
                                    'üîç Discover Posts'
                                )}
                            </button>
                        </div>
                    </div>

                    {/* Discovery Configuration */}
                    <div className="card" style={{marginBottom: '2rem'}}>
                        <h3>Discovery Configuration</h3>
                        <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '1rem', marginTop: '1rem'}}>
                            <div className="form-group">
                                <label>Max Posts to Analyze</label>
                                <input
                                    type="number"
                                    className="form-control"
                                    value={discoveryConfig.max_posts}
                                    onChange={(e) => handleConfigChange('max_posts', parseInt(e.target.value))}
                                    min="10"
                                    max="100"
                                />
                            </div>
                            
                            <div className="form-group">
                                <label>Discovery Sources</label>
                                <select
                                    className="form-control"
                                    value={discoveryConfig.sources[0]}
                                    onChange={(e) => handleConfigChange('sources', [e.target.value])}
                                >
                                    <option value="feed">LinkedIn Feed</option>
                                    <option value="network">Network Posts</option>
                                    <option value="industry">Industry Topics</option>
                                </select>
                            </div>
                            
                            <div className="form-group">
                                <label>Relevance Threshold</label>
                                <select
                                    className="form-control"
                                    value={discoveryConfig.min_relevance_score}
                                    onChange={(e) => handleConfigChange('min_relevance_score', parseFloat(e.target.value))}
                                >
                                    <option value="0.5">50% - More Opportunities</option>
                                    <option value="0.6">60% - Balanced</option>
                                    <option value="0.7">70% - Higher Quality</option>
                                    <option value="0.8">80% - Very Selective</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    {/* Discovery Status */}
                    {lastDiscovery && (
                        <div className="card" style={{marginBottom: '2rem'}}>
                            <h3>Last Discovery Results</h3>
                            <div className="stats" style={{marginTop: '1rem'}}>
                                <div className="stat-card">
                                    <div className="stat-number">{lastDiscovery.posts_found}</div>
                                    <div>Posts Analyzed</div>
                                </div>
                                <div className="stat-card">
                                    <div className="stat-number">{lastDiscovery.opportunities_created}</div>
                                    <div>Opportunities Created</div>
                                </div>
                                <div className="stat-card">
                                    <div className="stat-number">{lastDiscovery.processing_time?.toFixed(1)}s</div>
                                    <div>Processing Time</div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Comment Opportunities */}
                    <div className="card">
                        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem'}}>
                            <h3>Comment Opportunities ({opportunities.length})</h3>
                            {opportunities.length > 0 && (
                                <div style={{display: 'flex', gap: '0.5rem'}}>
                                    <button 
                                        className="btn btn-secondary"
                                        onClick={() => {
                                            const selectedIds = opportunities.map(opp => opp.id);
                                            handleBulkAction('schedule', selectedIds);
                                        }}
                                        disabled={loading}
                                    >
                                        üìÖ Schedule All
                                    </button>
                                    <button 
                                        className="btn btn-primary"
                                        onClick={() => {
                                            const highPriorityIds = opportunities
                                                .filter(opp => opp.priority === 'high' || opp.priority === 'urgent')
                                                .map(opp => opp.id);
                                            if (highPriorityIds.length > 0) {
                                                handleBulkAction('execute', highPriorityIds);
                                            } else {
                                                addToast('No high priority opportunities found', 'warning');
                                            }
                                        }}
                                        disabled={loading}
                                    >
                                        üöÄ Execute High Priority
                                    </button>
                                </div>
                            )}
                        </div>

                        {loading && opportunities.length === 0 ? (
                            <div className="loading">Loading opportunities...</div>
                        ) : opportunities.length === 0 ? (
                            <div className="empty-state">
                                <h4>No comment opportunities found</h4>
                                <p>Run post discovery to find new commenting opportunities!</p>
                            </div>
                        ) : (
                            <div>
                                {opportunities.map(opportunity => (
                                    <CommentOpportunityCard 
                                        key={opportunity.id} 
                                        opportunity={opportunity}
                                        onUpdate={loadCommentOpportunities}
                                    />
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // CommentOpportunityCard Component
        const CommentOpportunityCard = ({ opportunity, onUpdate }) => {
            const [expanded, setExpanded] = useState(false);
            const [generatedComment, setGeneratedComment] = useState(null);
            const [loading, setLoading] = useState(false);
            const { apiCall, addToast } = useApi();

            const getPriorityColor = (priority) => {
                switch (priority) {
                    case 'urgent': return '#dc3545';
                    case 'high': return '#fd7e14';
                    case 'medium': return '#ffc107';
                    case 'low': return '#6c757d';
                    default: return '#6c757d';
                }
            };

            const getStatusColor = (status) => {
                switch (status) {
                    case 'pending': return '#6c757d';
                    case 'scheduled': return '#ffc107';
                    case 'completed': return '#28a745';
                    case 'failed': return '#dc3545';
                    default: return '#6c757d';
                }
            };

            const handleGenerateComment = async (approach = 'thoughtful') => {
                try {
                    setLoading(true);
                    const result = await apiCall(`/engagement/comment-opportunities/${opportunity.id}/generate-comment?comment_approach=${approach}`, {
                        method: 'POST'
                    });
                    
                    setGeneratedComment(result);
                    addToast('Comment generated successfully!', 'success');
                    
                } catch (err) {
                    addToast('Failed to generate comment: ' + err.message, 'error');
                } finally {
                    setLoading(false);
                }
            };

            const handleExecuteComment = async () => {
                try {
                    setLoading(true);
                    const result = await apiCall(`/engagement/comment-opportunities/${opportunity.id}/execute`, {
                        method: 'POST'
                    });
                    
                    if (result.success) {
                        addToast('Comment posted successfully!', 'success');
                        onUpdate();
                    } else {
                        addToast('Comment execution failed: ' + result.error_message, 'error');
                    }
                    
                } catch (err) {
                    addToast('Failed to execute comment: ' + err.message, 'error');
                } finally {
                    setLoading(false);
                }
            };

            const handleScheduleComment = async () => {
                try {
                    setLoading(true);
                    const result = await apiCall(`/engagement/comment-opportunities/${opportunity.id}/schedule`, {
                        method: 'POST'
                    });
                    
                    addToast('Comment scheduled successfully!', 'success');
                    onUpdate();
                    
                } catch (err) {
                    addToast('Failed to schedule comment: ' + err.message, 'error');
                } finally {
                    setLoading(false);
                }
            };

            const handleSkip = async () => {
                try {
                    setLoading(true);
                    await apiCall(`/engagement/opportunities/${opportunity.id}/skip`, {
                        method: 'POST'
                    });
                    
                    addToast('Opportunity skipped', 'success');
                    onUpdate();
                    
                } catch (err) {
                    addToast('Failed to skip opportunity: ' + err.message, 'error');
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="card" style={{marginBottom: '1rem', border: `2px solid ${getPriorityColor(opportunity.priority)}20`}}>
                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '1rem'}}>
                        <div style={{flex: 1}}>
                            <div style={{display: 'flex', alignItems: 'center', gap: '0.5rem', marginBottom: '0.5rem'}}>
                                <h4 style={{margin: 0}}>Post by {opportunity.target_author}</h4>
                                <span 
                                    className="tag" 
                                    style={{background: getPriorityColor(opportunity.priority), color: 'white'}}
                                >
                                    {opportunity.priority?.toUpperCase()}
                                </span>
                                <span 
                                    className="tag" 
                                    style={{background: getStatusColor(opportunity.status), color: 'white'}}
                                >
                                    {opportunity.status?.toUpperCase()}
                                </span>
                            </div>
                            
                            {opportunity.relevance_score && (
                                <div style={{marginBottom: '0.5rem'}}>
                                    <span className="tag">Relevance: {opportunity.relevance_score}%</span>
                                    {opportunity.context_tags?.map(tag => (
                                        <span key={tag} className="tag">{tag}</span>
                                    ))}
                                </div>
                            )}
                        </div>
                        
                        <button 
                            className="btn btn-secondary"
                            onClick={() => setExpanded(!expanded)}
                            style={{padding: '0.25rem 0.5rem'}}
                        >
                            {expanded ? '‚ñº' : '‚ñ∂'}
                        </button>
                    </div>

                    <p style={{
                        display: '-webkit-box',
                        WebkitLineClamp: expanded ? 'none' : 3,
                        WebkitBoxOrient: 'vertical',
                        overflow: 'hidden',
                        marginBottom: '1rem',
                        color: '#666'
                    }}>
                        {opportunity.target_content}
                    </p>

                    {opportunity.engagement_reason && (
                        <p style={{fontStyle: 'italic', color: '#666', marginBottom: '1rem'}}>
                            <strong>Why comment:</strong> {opportunity.engagement_reason}
                        </p>
                    )}

                    {expanded && (
                        <div>
                            {/* Generated Comment Section */}
                            {generatedComment && (
                                <div style={{
                                    background: '#f8f9fa',
                                    padding: '1rem',
                                    borderRadius: '8px',
                                    marginBottom: '1rem',
                                    border: '1px solid #e9ecef'
                                }}>
                                    <h5>Generated Comment:</h5>
                                    <p style={{fontStyle: 'italic', marginBottom: '0.5rem'}}>{generatedComment.comment_text}</p>
                                    <div style={{fontSize: '0.9rem', color: '#666'}}>
                                        <span className="tag">Confidence: {(generatedComment.confidence_score * 100).toFixed(0)}%</span>
                                        <span className="tag">Approach: {generatedComment.approach_used}</span>
                                    </div>
                                    {generatedComment.alternative_comments?.length > 0 && (
                                        <details style={{marginTop: '0.5rem'}}>
                                            <summary style={{cursor: 'pointer', color: '#0077b5'}}>
                                                Alternative comments ({generatedComment.alternative_comments.length})
                                            </summary>
                                            <ul style={{marginTop: '0.5rem', paddingLeft: '1rem'}}>
                                                {generatedComment.alternative_comments.map((alt, idx) => (
                                                    <li key={idx} style={{marginBottom: '0.25rem'}}>{alt}</li>
                                                ))}
                                            </ul>
                                        </details>
                                    )}
                                </div>
                            )}

                            {/* Comment Generation Options */}
                            <div style={{marginBottom: '1rem'}}>
                                <h5>Generate Comment:</h5>
                                <div style={{display: 'flex', gap: '0.5rem', flexWrap: 'wrap'}}>
                                    {['thoughtful', 'expert_insight', 'engaging_question', 'supportive'].map(approach => (
                                        <button
                                            key={approach}
                                            className="btn btn-secondary"
                                            onClick={() => handleGenerateComment(approach)}
                                            disabled={loading}
                                            style={{fontSize: '0.9rem', padding: '0.25rem 0.5rem'}}
                                        >
                                            {loading ? <span className="loading-spinner" style={{width: '0.8em', height: '0.8em'}} /> : ''}
                                            {approach.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Action Buttons */}
                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                        <div>
                            <small style={{color: '#666'}}>
                                Created: {new Date(opportunity.created_at).toLocaleString()}
                                {opportunity.target_url && (
                                    <>
                                        {' ‚Ä¢ '}
                                        <a 
                                            href={opportunity.target_url} 
                                            target="_blank" 
                                            rel="noopener noreferrer"
                                            style={{color: '#0077b5'}}
                                        >
                                            View Post
                                        </a>
                                    </>
                                )}
                            </small>
                        </div>
                        
                        <div style={{display: 'flex', gap: '0.5rem'}}>
                            {opportunity.status === 'pending' && (
                                <>
                                    <button 
                                        className="btn btn-secondary"
                                        onClick={handleSkip}
                                        disabled={loading}
                                        style={{fontSize: '0.9rem'}}
                                    >
                                        ‚è≠Ô∏è Skip
                                    </button>
                                    <button 
                                        className="btn btn-secondary"
                                        onClick={handleScheduleComment}
                                        disabled={loading}
                                        style={{fontSize: '0.9rem'}}
                                    >
                                        üìÖ Schedule
                                    </button>
                                    <button 
                                        className="btn btn-primary"
                                        onClick={handleExecuteComment}
                                        disabled={loading}
                                        style={{fontSize: '0.9rem'}}
                                    >
                                        {loading ? <span className="loading-spinner" style={{width: '0.8em', height: '0.8em'}} /> : 'üöÄ'} 
                                        Comment Now
                                    </button>
                                </>
                            )}
                            
                            {opportunity.status === 'scheduled' && (
                                <span className="tag" style={{background: '#ffc107', color: '#000'}}>
                                    Scheduled for {opportunity.scheduled_for ? new Date(opportunity.scheduled_for).toLocaleString() : 'Optimal Time'}
                                </span>
                            )}
                            
                            {opportunity.status === 'completed' && (
                                <span className="tag" style={{background: '#28a745', color: 'white'}}>
                                    ‚úÖ Comment Posted
                                </span>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // CommentQueueTab Component
        const CommentQueueTab = () => {
            const [queueItems, setQueueItems] = useState([]);
            const [loading, setLoading] = useState(false);
            const [statusFilter, setStatusFilter] = useState('');
            const [selectedItems, setSelectedItems] = useState(new Set());
            const { apiCall, addToast } = useApi();

            useEffect(() => {
                loadCommentQueue();
            }, [statusFilter]);

            const loadCommentQueue = async () => {
                try {
                    setLoading(true);
                    const params = new URLSearchParams({
                        limit: '100'
                    });
                    if (statusFilter) {
                        params.append('status_filter', statusFilter);
                    }
                    
                    const data = await apiCall(`/engagement/comment-queue?${params}`);
                    setQueueItems(data);
                } catch (err) {
                    console.error('Failed to load comment queue:', err);
                } finally {
                    setLoading(false);
                }
            };

            const handleItemSelection = (itemId, selected) => {
                const newSelected = new Set(selectedItems);
                if (selected) {
                    newSelected.add(itemId);
                } else {
                    newSelected.delete(itemId);
                }
                setSelectedItems(newSelected);
            };

            const handleSelectAll = (selectAll) => {
                if (selectAll) {
                    setSelectedItems(new Set(queueItems.map(item => item.id)));
                } else {
                    setSelectedItems(new Set());
                }
            };

            const handleBulkAction = async (action) => {
                if (selectedItems.size === 0) {
                    addToast('Please select items to perform bulk action', 'warning');
                    return;
                }

                try {
                    setLoading(true);
                    
                    const result = await apiCall('/engagement/bulk-comment-actions', {
                        method: 'POST',
                        body: JSON.stringify({
                            opportunity_ids: Array.from(selectedItems),
                            action: action
                        })
                    });
                    
                    addToast(`Bulk ${action} completed: ${result.results.successful} successful`, 'success');
                    setSelectedItems(new Set());
                    await loadCommentQueue();
                    
                } catch (err) {
                    addToast(`Bulk ${action} failed: ` + err.message, 'error');
                } finally {
                    setLoading(false);
                }
            };

            const getStatusCounts = () => {
                const counts = {
                    pending: 0,
                    scheduled: 0,
                    completed: 0,
                    failed: 0,
                    skipped: 0
                };
                
                queueItems.forEach(item => {
                    counts[item.status] = (counts[item.status] || 0) + 1;
                });
                
                return counts;
            };

            const statusCounts = getStatusCounts();

            return (
                <div>
                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '2rem'}}>
                        <h2>Comment Queue</h2>
                        <div style={{display: 'flex', gap: '0.5rem', alignItems: 'center'}}>
                            <select
                                className="form-control"
                                value={statusFilter}
                                onChange={(e) => setStatusFilter(e.target.value)}
                                style={{width: 'auto', minWidth: '150px'}}
                            >
                                <option value="">All Status</option>
                                <option value="pending">Pending ({statusCounts.pending})</option>
                                <option value="scheduled">Scheduled ({statusCounts.scheduled})</option>
                                <option value="completed">Completed ({statusCounts.completed})</option>
                                <option value="failed">Failed ({statusCounts.failed})</option>
                                <option value="skipped">Skipped ({statusCounts.skipped})</option>
                            </select>
                            <button 
                                className="btn btn-secondary"
                                onClick={loadCommentQueue}
                                disabled={loading}
                            >
                                üîÑ Refresh
                            </button>
                        </div>
                    </div>

                    {/* Queue Statistics */}
                    <div className="stats" style={{marginBottom: '2rem'}}>
                        <div className="stat-card">
                            <div className="stat-number">{statusCounts.pending}</div>
                            <div>Pending</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-number">{statusCounts.scheduled}</div>
                            <div>Scheduled</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-number">{statusCounts.completed}</div>
                            <div>Completed</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-number">{statusCounts.failed}</div>
                            <div>Failed</div>
                        </div>
                    </div>

                    {/* Bulk Actions */}
                    {queueItems.length > 0 && (
                        <div className="card" style={{marginBottom: '2rem'}}>
                            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                                <div style={{display: 'flex', alignItems: 'center', gap: '1rem'}}>
                                    <label style={{display: 'flex', alignItems: 'center', gap: '0.5rem'}}>
                                        <input
                                            type="checkbox"
                                            checked={selectedItems.size === queueItems.length && queueItems.length > 0}
                                            onChange={(e) => handleSelectAll(e.target.checked)}
                                        />
                                        Select All ({selectedItems.size} selected)
                                    </label>
                                </div>
                                
                                {selectedItems.size > 0 && (
                                    <div style={{display: 'flex', gap: '0.5rem'}}>
                                        <button 
                                            className="btn btn-secondary"
                                            onClick={() => handleBulkAction('schedule')}
                                            disabled={loading}
                                        >
                                            üìÖ Schedule Selected
                                        </button>
                                        <button 
                                            className="btn btn-secondary"
                                            onClick={() => handleBulkAction('skip')}
                                            disabled={loading}
                                        >
                                            ‚è≠Ô∏è Skip Selected
                                        </button>
                                        <button 
                                            className="btn btn-primary"
                                            onClick={() => handleBulkAction('execute')}
                                            disabled={loading}
                                        >
                                            üöÄ Execute Selected
                                        </button>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {/* Queue Items */}
                    <div className="card">
                        {loading && queueItems.length === 0 ? (
                            <div className="loading">Loading comment queue...</div>
                        ) : queueItems.length === 0 ? (
                            <div className="empty-state">
                                <h4>No items in comment queue</h4>
                                <p>Discover new posts to populate your comment queue!</p>
                            </div>
                        ) : (
                            <div>
                                {queueItems.map(item => (
                                    <div key={item.id} style={{
                                        display: 'flex',
                                        alignItems: 'flex-start',
                                        gap: '1rem',
                                        padding: '1rem',
                                        borderBottom: '1px solid #e9ecef',
                                        background: selectedItems.has(item.id) ? '#f8f9fa' : 'transparent'
                                    }}>
                                        <input
                                            type="checkbox"
                                            checked={selectedItems.has(item.id)}
                                            onChange={(e) => handleItemSelection(item.id, e.target.checked)}
                                        />
                                        
                                        <div style={{flex: 1}}>
                                            <CommentOpportunityCard 
                                                opportunity={item}
                                                onUpdate={loadCommentQueue}
                                            />
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // CommentAnalyticsTab Component
        const CommentAnalyticsTab = () => {
            const [analytics, setAnalytics] = useState(null);
            const [loading, setLoading] = useState(false);
            const [timeRange, setTimeRange] = useState(30);
            const { apiCall } = useApi();

            useEffect(() => {
                loadAnalytics();
            }, [timeRange]);

            const loadAnalytics = async () => {
                try {
                    setLoading(true);
                    const data = await apiCall(`/engagement/comment-analytics?days=${timeRange}`);
                    setAnalytics(data);
                } catch (err) {
                    console.error('Failed to load comment analytics:', err);
                } finally {
                    setLoading(false);
                }
            };

            if (loading && !analytics) {
                return <div className="loading">Loading analytics...</div>;
            }

            if (!analytics) {
                return (
                    <div className="empty-state">
                        <h3>No analytics data available</h3>
                        <p>Start discovering and commenting on posts to see analytics!</p>
                    </div>
                );
            }

            return (
                <div>
                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '2rem'}}>
                        <h2>Comment Analytics</h2>
                        <div style={{display: 'flex', gap: '0.5rem', alignItems: 'center'}}>
                            <select
                                className="form-control"
                                value={timeRange}
                                onChange={(e) => setTimeRange(parseInt(e.target.value))}
                                style={{width: 'auto'}}
                            >
                                <option value="7">Last 7 days</option>
                                <option value="30">Last 30 days</option>
                                <option value="90">Last 90 days</option>
                            </select>
                            <button 
                                className="btn btn-secondary"
                                onClick={loadAnalytics}
                                disabled={loading}
                            >
                                üîÑ Refresh
                            </button>
                        </div>
                    </div>

                    {/* Key Metrics */}
                    <div className="stats" style={{marginBottom: '2rem'}}>
                        <div className="stat-card">
                            <div className="stat-number">{analytics.total_comment_opportunities}</div>
                            <div>Opportunities Found</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-number">{analytics.comments_posted}</div>
                            <div>Comments Posted</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-number">{analytics.success_rate.toFixed(1)}%</div>
                            <div>Success Rate</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-number">{analytics.comments_pending}</div>
                            <div>Pending</div>
                        </div>
                    </div>

                    {/* Performance Breakdown */}
                    <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '2rem', marginBottom: '2rem'}}>
                        <div className="card">
                            <h3>Comment Status Breakdown</h3>
                            <div style={{marginTop: '1rem'}}>
                                {[
                                    {label: 'Posted', value: analytics.comments_posted, color: '#28a745'},
                                    {label: 'Pending', value: analytics.comments_pending, color: '#6c757d'},
                                    {label: 'Scheduled', value: analytics.comments_scheduled, color: '#ffc107'},
                                    {label: 'Failed', value: analytics.comments_failed, color: '#dc3545'},
                                    {label: 'Skipped', value: analytics.comments_skipped, color: '#6f42c1'}
                                ].map(item => (
                                    <div key={item.label} style={{
                                        display: 'flex',
                                        justifyContent: 'space-between',
                                        alignItems: 'center',
                                        padding: '0.5rem 0',
                                        borderBottom: '1px solid #f0f0f0'
                                    }}>
                                        <div style={{display: 'flex', alignItems: 'center', gap: '0.5rem'}}>
                                            <div style={{
                                                width: '12px',
                                                height: '12px',
                                                borderRadius: '50%',
                                                background: item.color
                                            }}></div>
                                            {item.label}
                                        </div>
                                        <strong>{item.value}</strong>
                                    </div>
                                ))}
                            </div>
                        </div>

                        <div className="card">
                            <h3>Discovery Performance</h3>
                            {analytics.discovery_metrics && (
                                <div style={{marginTop: '1rem'}}>
                                    <div style={{marginBottom: '1rem'}}>
                                        <strong>Total Discovered:</strong> {analytics.discovery_metrics.total_discovered}
                                    </div>
                                    <div style={{marginBottom: '1rem'}}>
                                        <strong>Avg per Day:</strong> {analytics.discovery_metrics.avg_opportunities_per_day?.toFixed(1)}
                                    </div>
                                    {analytics.discovery_metrics.sources_breakdown && (
                                        <div>
                                            <strong>Sources:</strong>
                                            <ul style={{marginTop: '0.5rem', paddingLeft: '1rem'}}>
                                                {Object.entries(analytics.discovery_metrics.sources_breakdown).map(([source, count]) => (
                                                    <li key={source}>{source}: {count}</li>
                                                ))}
                                            </ul>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Insights */}
                    <div className="card">
                        <h3>Insights & Recommendations</h3>
                        <div style={{marginTop: '1rem'}}>
                            {analytics.success_rate > 80 && (
                                <div className="alert alert-success">
                                    üéâ Excellent performance! Your comment success rate is {analytics.success_rate.toFixed(1)}%
                                </div>
                            )}
                            
                            {analytics.success_rate < 50 && (
                                <div className="alert alert-warning" style={{background: '#fff3cd', color: '#856404', border: '1px solid #ffeaa7'}}>
                                    ‚ö†Ô∏è Low success rate ({analytics.success_rate.toFixed(1)}%). Consider adjusting your commenting criteria or timing.
                                </div>
                            )}
                            
                            {analytics.comments_pending > analytics.comments_posted && (
                                <div className="alert alert-info" style={{background: '#d1ecf1', color: '#0c5460', border: '1px solid #bee5eb'}}>
                                    üí° You have more pending opportunities than posted comments. Consider scheduling or executing pending opportunities.
                                </div>
                            )}
                            
                            {analytics.total_comment_opportunities === 0 && (
                                <div className="alert alert-warning" style={{background: '#fff3cd', color: '#856404', border: '1px solid #ffeaa7'}}>
                                    üîç No opportunities found in the selected period. Try running post discovery to find new commenting opportunities.
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // Render the app
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>