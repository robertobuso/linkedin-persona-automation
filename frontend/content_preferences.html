<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content Preferences</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 2rem;
        }
        
        .header {
            text-align: center;
            margin-bottom: 2rem;
            color: #333;
        }
        
        .section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: #f8f9fa;
            border-radius: 12px;
            border-left: 4px solid #0077b5;
        }
        
        .section h3 {
            margin-bottom: 1rem;
            color: #0077b5;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #555;
        }
        
        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #0077b5;
        }
        
        .interest-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .interest-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem;
            background: white;
            border-radius: 8px;
            border: 2px solid #e9ecef;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .interest-item:hover {
            border-color: #0077b5;
            background: #f0f7ff;
        }
        
        .interest-item.selected {
            background: #0077b5;
            color: white;
            border-color: #0077b5;
        }
        
        .slider-container {
            margin-top: 1rem;
        }
        
        .slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e9ecef;
            outline: none;
            -webkit-appearance: none;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #0077b5;
            cursor: pointer;
        }
        
        .slider-value {
            text-align: center;
            margin-top: 0.5rem;
            font-weight: 500;
            color: #0077b5;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            font-size: 1rem;
        }
        
        .btn-primary {
            background: #0077b5;
            color: white;
        }
        
        .btn-primary:hover {
            background: #005885;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: #e9ecef;
            color: #495057;
        }
        
        .btn-secondary:hover {
            background: #dee2e6;
        }
        
        .actions {
            text-align: center;
            margin-top: 2rem;
            display: flex;
            gap: 1rem;
            justify-content: center;
        }
        
        .preview {
            background: #e8f4f8;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            font-style: italic;
            border-left: 3px solid #0077b5;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì° Content Discovery Preferences</h1>
            <p>Configure what kind of content you want to discover and analyze</p>
        </div>
        
        <div class="section">
            <h3>üë§ Professional Context</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                    <label>Job Role</label>
                    <select class="form-control" id="jobRole">
                        <option value="">Select your role...</option>
                        <option value="software_engineer">Software Engineer</option>
                        <option value="product_manager">Product Manager</option>
                        <option value="data_scientist">Data Scientist</option>
                        <option value="engineering_manager">Engineering Manager</option>
                        <option value="founder_ceo">Founder/CEO</option>
                        <option value="marketing_manager">Marketing Manager</option>
                        <option value="sales_professional">Sales Professional</option>
                        <option value="consultant">Consultant</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Industry</label>
                    <select class="form-control" id="industry">
                        <option value="">Select industry...</option>
                        <option value="technology">Technology</option>
                        <option value="finance">Finance</option>
                        <option value="healthcare">Healthcare</option>
                        <option value="consulting">Consulting</option>
                        <option value="education">Education</option>
                        <option value="retail">Retail</option>
                        <option value="manufacturing">Manufacturing</option>
                        <option value="other">Other</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div class="section">
            <h3>üí° Content Interests</h3>
            <div class="interest-grid" id="interestGrid">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>
        
        <div class="section">
            <h3>‚ú® Custom Instructions</h3>
            <div class="form-group">
                <label>Tell the AI what you want to see (optional)</label>
                <textarea 
                    class="form-control" 
                    id="customPrompt"
                    rows="4"
                    placeholder="Example: I'm interested in emerging technologies that could impact healthcare, especially AI applications in medical diagnosis. I prefer in-depth technical articles over news briefs."
                ></textarea>
            </div>
            <div class="preview" id="promptPreview">
                Your custom instructions will help the AI understand exactly what content you find valuable.
            </div>
        </div>
        
        <div class="section">
            <h3>‚öôÔ∏è Content Filters</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <label>Relevance Threshold</label>
                    <div class="slider-container">
                        <input type="range" min="50" max="95" value="70" class="slider" id="relevanceSlider">
                        <div class="slider-value" id="relevanceValue">70% - Balanced</div>
                    </div>
                </div>
                <div>
                    <label>Articles Per Day</label>
                    <div class="slider-container">
                        <input type="range" min="5" max="30" value="15" class="slider" id="articleCountSlider">
                        <div class="slider-value" id="articleCountValue">15 articles</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="actions">
            <button class="btn btn-secondary" onclick="previewChanges()">üëÄ Preview</button>
            <button class="btn btn-primary" onclick="savePreferences()">üíæ Save Preferences</button>
        </div>
    </div>
    
    <script>
        // Set this specifically for this page if it's not served by the proxied dev server
        window.APP_CONFIG = {
            API_BASE_URL: 'http://localhost:8000/api/v1' // Points directly to your FastAPI backend
        };
    </script>
    <script>
        const interests = [
            { id: 'ai_ml', label: 'ü§ñ AI & Machine Learning', selected: false },
            { id: 'software_engineering', label: 'üíª Software Engineering', selected: false },
            { id: 'product_management', label: 'üì± Product Management', selected: false },
            { id: 'data_science', label: 'üìä Data Science', selected: false },
            { id: 'blockchain', label: '‚õìÔ∏è Blockchain & Web3', selected: false },
            { id: 'cloud_computing', label: '‚òÅÔ∏è Cloud Computing', selected: false },
            { id: 'cybersecurity', label: 'üîí Cybersecurity', selected: false },
            { id: 'devops', label: 'üîÑ DevOps & Infrastructure', selected: false },
            { id: 'startups', label: 'üöÄ Startups & Entrepreneurship', selected: false },
            { id: 'leadership', label: 'üë• Leadership & Management', selected: false },
            { id: 'finance_tech', label: 'üí≥ FinTech', selected: false },
            { id: 'mobile_development', label: 'üì± Mobile Development', selected: false }
        ];
        
        function renderInterests() {
            const grid = document.getElementById('interestGrid');
            grid.innerHTML = interests.map(interest => `
                <div class="interest-item ${interest.selected ? 'selected' : ''}" 
                     onclick="toggleInterest('${interest.id}')">
                    <span>${interest.label}</span>
                </div>
            `).join('');
        }
        
        function toggleInterest(id) {
            const interest = interests.find(i => i.id === id);
            interest.selected = !interest.selected;
            renderInterests();
            updatePreview();
        }
        
        function updateSliderValue(sliderId, valueId, formatter) {
            const slider = document.getElementById(sliderId);
            const valueDisplay = document.getElementById(valueId);
            const value = parseInt(slider.value);
            valueDisplay.textContent = formatter(value);
        }
        
        function setupSliders() {
            const relevanceSlider = document.getElementById('relevanceSlider');
            const articleCountSlider = document.getElementById('articleCountSlider');
            
            relevanceSlider.addEventListener('input', () => {
                const value = parseInt(relevanceSlider.value);
                let label = 'Balanced';
                if (value < 60) label = 'Permissive';
                else if (value > 80) label = 'Strict';
                
                updateSliderValue('relevanceSlider', 'relevanceValue', 
                    (v) => `${v}% - ${label}`);
            });
            
            articleCountSlider.addEventListener('input', () => {
                updateSliderValue('articleCountSlider', 'articleCountValue', 
                    (v) => `${v} articles`);
            });
        }
        
        function updatePreview() {
            const selectedInterests = interests.filter(i => i.selected);
            const customPrompt = document.getElementById('customPrompt').value;
            const preview = document.getElementById('promptPreview');
            
            if (selectedInterests.length > 0 || customPrompt) {
                let previewText = 'The AI will look for content about: ';
                
                if (selectedInterests.length > 0) {
                    previewText += selectedInterests.map(i => i.label.replace(/^.+?\s/, '')).join(', ');
                }
                
                if (customPrompt) {
                    previewText += (selectedInterests.length > 0 ? '. ' : '') + 
                        'Custom instructions: "' + customPrompt.substring(0, 100) + 
                        (customPrompt.length > 100 ? '..."' : '"');
                }
                
                preview.innerHTML = previewText;
            } else {
                preview.innerHTML = 'Your custom instructions will help the AI understand exactly what content you find valuable.';
            }
        }
        
        function previewChanges() {
            const selectedInterests = interests.filter(i => i.selected);
            const jobRole = document.getElementById('jobRole').value;
            const industry = document.getElementById('industry').value;
            const customPrompt = document.getElementById('customPrompt').value;
            const relevance = document.getElementById('relevanceSlider').value;
            const articleCount = document.getElementById('articleCountSlider').value;
            
            alert(`Preview of your content preferences:
            
Role: ${jobRole || 'Not specified'}
Industry: ${industry || 'Not specified'}
Interests: ${selectedInterests.map(i => i.label.replace(/^.+?\s/, '')).join(', ') || 'None selected'}
Custom Instructions: ${customPrompt || 'None'}
Relevance Threshold: ${relevance}%
Articles per day: ${articleCount}

The AI will use these preferences to select the most relevant articles for you.`);
        }
        
        const API_BASE = window.APP_CONFIG?.API_BASE_URL || '/api/v1'; // Will now pick up the absolute URL

        async function apiCall(endpoint, options = {}) {
            // 1. Use 'token' and ensure 'localStorage.getItem' uses the correct key
            const token = localStorage.getItem('token'); // Or 'accessToken' if that's your actual key
            // If your key in localStorage is 'accessToken', use:
            // const token = localStorage.getItem('accessToken'); 

            if (!token && !options.isPublic) { // Assuming some endpoints might be public
                throw new Error('Authentication token not found. Please log in.');
            }

            const defaultHeaders = {
                'Content-Type': 'application/json',
            };
            if (token && !options.isPublic) { // 2. Use the 'token' variable here
                defaultHeaders['Authorization'] = `Bearer ${token}`;
            }

            const config = {
                ...options,
                headers: {
                    ...defaultHeaders,
                    ...options.headers,
                },
            };

            const response = await fetch(`${API_BASE}${endpoint}`, config);

            if (!response.ok) {
                let errorDetail = `HTTP error! status: ${response.status}`;
                try {
                    const errorData = await response.json();
                    if (errorData && errorData.detail) {
                        if (Array.isArray(errorData.detail)) {
                            errorDetail = errorData.detail.map(err => `${err.loc.join('.')} - ${err.msg}`).join('; ');
                        } else {
                            errorDetail = errorData.detail;
                        }
                    }
                } catch (e) {
                    errorDetail = response.statusText || errorDetail;
                }
                throw new Error(errorDetail);
            }

            if (response.status === 204 || (options.method === 'DELETE' && response.headers.get("content-length") === "0")) {
                return null; 
            }
            
            return response.json();
        }

        async function savePreferences() {
            // No need to get authToken here, apiCall will handle it.

            const payload = {
                jobRole: document.getElementById('jobRole').value,
                industry: document.getElementById('industry').value,
                interests: interests.filter(i => i.selected).map(i => i.id),
                customPrompt: document.getElementById('customPrompt').value,
                relevanceThreshold: parseInt(document.getElementById('relevanceSlider').value) / 100,
                maxArticlesPerDay: parseInt(document.getElementById('articleCountSlider').value)
            };
            
            console.log('Attempting to save preferences with payload:', payload);
            
            // Disable button to prevent multiple clicks
            const saveButton = document.querySelector('.btn-primary[onclick="savePreferences()"]');
            if (saveButton) saveButton.disabled = true;


            try {
                // Using the new apiCall utility
                const result = await apiCall('/preferences/quick-setup', {
                    method: 'POST',
                    body: JSON.stringify(payload),
                });

                console.log('User preferences saved successfully via API:', result);
                alert('‚úÖ Preferences saved successfully! Your content feed will be updated within the next hour.');
                // Optionally, you could reload current preferences or update UI fields
                // loadPreferences(); // If you implement a function to fetch and populate the form

            } catch (error) {
                console.error('Error saving preferences:', error);
                alert(`‚ùå Error saving preferences: ${error.message}`);
            } finally {
                // Re-enable button
                if (saveButton) saveButton.disabled = false;
            }
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            renderInterests();
            setupSliders();
            
            document.getElementById('customPrompt').addEventListener('input', updatePreview);
        });
    </script>
</body>
</html>